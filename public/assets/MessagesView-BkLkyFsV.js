import{e as as,r,b as R,w as ns,i as os,j as is,f as o,k as t,h as _,t as v,N as D,U as S,F,s as H,v as O,W as ls,Q as j,Y as E,V as rs,n as z,u as cs,o as i}from"./vendor-Cy2yCxOA.js";import{u as ds,b as p,_ as us}from"./index-OxM2XMo-.js";import"./utils-i9HKr1_Q.js";const vs={class:"messages-view"},ps={class:"messages-container"},ms={class:"conversations-panel"},_s={class:"conversations-header"},gs={class:"search-bar"},fs=["placeholder"],hs={key:0,class:"loading-container"},ys={key:1,class:"empty-conversations"},ws={key:2,class:"conversations-list"},ks=["onClick"],Cs={class:"conversation-avatar"},bs=["src","alt"],Ms={key:0,class:"online-indicator"},$s={class:"conversation-info"},Ts={class:"conversation-name"},xs={class:"conversation-preview"},Is={class:"conversation-meta"},Ns={class:"conversation-time"},Vs={key:0,class:"unread-badge"},Ds={class:"conversation-panel"},Ss={key:0,class:"no-conversation"},Fs={class:"conversation-header"},Es={class:"header-info"},Ls=["src","alt"],Us={class:"participant-details"},As={class:"participant-name"},Bs={class:"participant-status"},Ps={key:0,class:"typing-indicator"},Ks={key:0,class:"loading-container"},Rs={key:1,class:"empty-messages"},Hs={key:2,class:"messages-list"},Os=["src","alt"],js={class:"message-bubble"},zs={class:"message-text"},Qs={key:0,class:"message-attachment"},Ws=["src"],Ys={class:"message-time"},qs={key:0,class:"edited-label"},Gs={key:0,class:"typing-bubble"},Js={class:"message-input-container"},Xs=["onKeydown"],Zs=["disabled"],se={class:"modal-header"},ee={class:"modal-body"},te={class:"modal-footer"},ae=as({__name:"MessagesView",props:{conversationId:{}},setup(Q){const M=Q;cs();const L=rs(),U=ds(),d=r([]),m=r([]),n=r(null),C=r(""),f=r(""),$=r(!0),T=r(!1),x=r(!1),h=r(!1),y=r(""),b=r(null);let w=null,k=null;const A=R(()=>{if(!C.value)return d.value;const a=C.value.toLowerCase();return d.value.filter(e=>{var s;return e.participant_name.toLowerCase().includes(a)||((s=e.last_message)==null?void 0:s.toLowerCase().includes(a))})}),u=R(()=>n.value?d.value.find(a=>a.conversation_id===n.value):null),W=a=>{const e=new Date(a),l=new Date().getTime()-e.getTime(),c=Math.floor(l/6e4),g=Math.floor(l/36e5),V=Math.floor(l/864e5);return c<1?"now":c<60?`${c}m`:g<24?`${g}h`:V===1?"yesterday":V<7?`${V}d`:e.toLocaleDateString()},Y=a=>new Date(a).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),q=async()=>{try{$.value=!0;const a=await p.get("/conversations");a.data.success&&a.data.data.conversations&&(d.value=a.data.data.conversations)}catch(a){console.error("Error loading conversations:",a)}finally{$.value=!1}},I=async()=>{if(n.value)try{T.value=!0;const a=await p.get(`/conversations/${n.value}/messages`);a.data.success&&a.data.data.messages&&(m.value=a.data.data.messages.map(e=>{var s;return{...e,is_own:e.sender_id===((s=U.user)==null?void 0:s.user_id)}}),await E(),N(),K())}catch(a){console.error("Error loading messages:",a)}finally{T.value=!1}},B=a=>{n.value=a,L.push(`/messages/${a}`),I()},P=async()=>{var a,e;if(!(!f.value.trim()||!n.value))try{const s=await p.post(`/conversations/${n.value}/messages`,{message_text:f.value.trim()});if(s.data.success&&s.data.data.message){const l={...s.data.data.message,is_own:!0};m.value.push(l),f.value="",await E(),N();const c=d.value.find(g=>g.conversation_id===n.value);c&&(c.last_message=l.message_text,c.updated_at=l.created_at)}}catch(s){alert(((e=(a=s.response)==null?void 0:a.data)==null?void 0:e.message)||"Failed to send message")}},G=()=>{n.value&&(p.post(`/conversations/${n.value}/typing`),k&&clearTimeout(k),k=setTimeout(()=>{},2e3))},K=async()=>{if(n.value)try{await p.patch(`/conversations/${n.value}/read`);const a=d.value.find(e=>e.conversation_id===n.value);a&&(a.unread_count=0)}catch(a){console.error("Error marking as read:",a)}},N=()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)},J=async()=>{var a,e;if(y.value.trim())try{const s=await p.post("/conversations",{participant_username:y.value.trim()});if(s.data.success&&s.data.data.conversation){const l=s.data.data.conversation;d.value.unshift(l),B(l.conversation_id),h.value=!1,y.value=""}}catch(s){alert(((e=(a=s.response)==null?void 0:a.data)==null?void 0:e.message)||"Failed to start conversation")}},X=async()=>{var a,e;if(!(!n.value||!confirm("Delete this conversation?")))try{await p.delete(`/conversations/${n.value}`),d.value=d.value.filter(s=>s.conversation_id!==n.value),n.value=null,m.value=[]}catch(s){alert(((e=(a=s.response)==null?void 0:a.data)==null?void 0:e.message)||"Failed to delete conversation")}},Z=()=>{u.value&&L.push(`/profile/${u.value.participant_username}`)},ss=()=>{console.log("File attachment coming soon")},es=()=>{w||(w=setInterval(async()=>{var a;if(n.value){const e=(a=m.value[m.value.length-1])==null?void 0:a.message_id;try{const s=await p.get(`/conversations/${n.value}/messages?after=${e||0}`);if(s.data.success&&s.data.data.messages){const l=s.data.data.messages.map(c=>{var g;return{...c,is_own:c.sender_id===((g=U.user)==null?void 0:g.user_id)}});l.length>0&&(m.value.push(...l),await E(),N(),K())}}catch(s){console.error("Error polling messages:",s)}try{const s=await p.get(`/conversations/${n.value}/typing`);s.data.success&&s.data.data.typing_users&&(x.value=s.data.data.typing_users.length>0)}catch(s){console.error("Error checking typing status:",s)}}},3e3))},ts=()=>{w&&(clearInterval(w),w=null)};return ns(()=>M.conversationId,a=>{a&&(n.value=parseInt(a),I())}),os(()=>{q(),M.conversationId&&(n.value=parseInt(M.conversationId),I()),es()}),is(()=>{ts(),k&&clearTimeout(k)}),(a,e)=>(i(),o("div",vs,[t("div",ps,[t("div",ms,[t("div",_s,[t("h2",null,v(a.$t("navigation.messages")),1),t("button",{onClick:e[0]||(e[0]=s=>h.value=!0),class:"btn-new-message"},[...e[8]||(e[8]=[t("span",{class:"icon"},"✉️",-1)])])]),t("div",gs,[D(t("input",{"onUpdate:modelValue":e[1]||(e[1]=s=>C.value=s),type:"text",placeholder:a.$t("common.actions.search")+" conversations...",class:"search-input"},null,8,fs),[[S,C.value]])]),$.value?(i(),o("div",hs,[...e[9]||(e[9]=[t("div",{class:"spinner"},null,-1)])])):A.value.length===0?(i(),o("div",ys,[...e[10]||(e[10]=[t("p",null,"No conversations yet",-1)])])):(i(),o("div",ws,[(i(!0),o(F,null,H(A.value,s=>(i(),o("div",{key:s.conversation_id,class:z(["conversation-item",{active:n.value===s.conversation_id}]),onClick:l=>B(s.conversation_id)},[t("div",Cs,[t("img",{src:s.participant_avatar||"/assets/images/default-avatar.svg",alt:s.participant_name},null,8,bs),s.is_online?(i(),o("span",Ms)):_("",!0)]),t("div",$s,[t("div",Ts,v(s.participant_name),1),t("div",xs,v(s.last_message||"No messages"),1)]),t("div",Is,[t("span",Ns,v(W(s.updated_at)),1),s.unread_count>0?(i(),o("span",Vs,v(s.unread_count),1)):_("",!0)])],10,ks))),128))]))]),t("div",Ds,[u.value?(i(),o(F,{key:1},[t("div",Fs,[t("div",Es,[t("img",{src:u.value.participant_avatar||"/assets/images/default-avatar.svg",alt:u.value.participant_name,class:"participant-avatar"},null,8,Ls),t("div",Us,[t("div",As,v(u.value.participant_name),1),t("div",Bs,[O(v(u.value.is_online?"Online":"Offline")+" ",1),x.value?(i(),o("span",Ps," - typing...")):_("",!0)])])]),t("div",{class:"header-actions"},[t("button",{onClick:Z,class:"btn-icon",title:"View Profile"},[...e[12]||(e[12]=[t("span",null,"👤",-1)])]),t("button",{onClick:X,class:"btn-icon",title:"Delete Conversation"},[...e[13]||(e[13]=[t("span",null,"🗑️",-1)])])])]),t("div",{ref_key:"messagesContainer",ref:b,class:"messages-thread"},[T.value?(i(),o("div",Ks,[...e[14]||(e[14]=[t("div",{class:"spinner"},null,-1)])])):m.value.length===0?(i(),o("div",Rs,[...e[15]||(e[15]=[t("p",null,"No messages yet. Start the conversation!",-1)])])):(i(),o("div",Hs,[(i(!0),o(F,null,H(m.value,s=>(i(),o("div",{key:s.message_id,class:z(["message-item",{own:s.is_own}])},[s.is_own?_("",!0):(i(),o("img",{key:0,src:u.value.participant_avatar||"/assets/images/default-avatar.svg",alt:u.value.participant_name,class:"message-avatar"},null,8,Os)),t("div",js,[t("div",zs,v(s.message_text),1),s.attachment_url?(i(),o("div",Qs,[t("img",{src:s.attachment_url,alt:"Attachment",class:"attachment-image"},null,8,Ws)])):_("",!0),t("div",Ys,[O(v(Y(s.created_at))+" ",1),s.edited_at?(i(),o("span",qs,"(edited)")):_("",!0)])])],2))),128)),x.value?(i(),o("div",Gs,[...e[16]||(e[16]=[t("div",{class:"typing-dots"},[t("span"),t("span"),t("span")],-1)])])):_("",!0)]))],512),t("div",Js,[t("button",{onClick:ss,class:"btn-attach",title:"Attach File"},[...e[17]||(e[17]=[t("span",null,"📎",-1)])]),D(t("textarea",{"onUpdate:modelValue":e[2]||(e[2]=s=>f.value=s),onKeydown:ls(j(P,["exact","prevent"]),["enter"]),onInput:G,placeholder:"Type a message...",class:"message-input",rows:"1"},null,40,Xs),[[S,f.value]]),t("button",{onClick:P,disabled:!f.value.trim(),class:"btn-send"},[...e[18]||(e[18]=[t("span",null,"📤",-1)])],8,Zs)])],64)):(i(),o("div",Ss,[...e[11]||(e[11]=[t("div",{class:"empty-icon"},"💬",-1),t("h3",null,"Select a conversation",-1),t("p",null,"Choose a conversation from the list to start messaging",-1)])]))])]),h.value?(i(),o("div",{key:0,class:"modal-overlay",onClick:e[7]||(e[7]=s=>h.value=!1)},[t("div",{class:"modal-content",onClick:e[6]||(e[6]=j(()=>{},["stop"]))},[t("div",se,[e[19]||(e[19]=t("h3",null,"New Message",-1)),t("button",{onClick:e[3]||(e[3]=s=>h.value=!1),class:"btn-close"},"×")]),t("div",ee,[D(t("input",{"onUpdate:modelValue":e[4]||(e[4]=s=>y.value=s),type:"text",placeholder:"Enter username...",class:"username-input"},null,512),[[S,y.value]])]),t("div",te,[t("button",{onClick:e[5]||(e[5]=s=>h.value=!1),class:"btn-secondary"},"Cancel"),t("button",{onClick:J,class:"btn-primary"},"Start")])])])):_("",!0)]))}}),le=us(ae,[["__scopeId","data-v-5bdf07c8"]]);export{le as default};
//# sourceMappingURL=MessagesView-BkLkyFsV.js.map
