import{f as ae,r as u,b as R,w as ne,e as oe,o as ie,g as i,k as t,j as f,t as p,O as V,V as N,F,x as K,y as H,W as le,R as j,Y as E,u as re,n as z,v as ce,i as l}from"./vendor-B5QdKGWw.js";import{u as de,b as _,_ as ue}from"./index-B9pqkw3o.js";import"./utils-i9HKr1_Q.js";const ve={class:"messages-view"},me={class:"messages-container"},pe={class:"conversations-panel"},_e={class:"conversations-header"},ge={class:"search-bar"},fe=["placeholder"],he={key:0,class:"loading-container"},ye={key:1,class:"empty-conversations"},we={key:2,class:"conversations-list"},ke=["onClick"],Ce={class:"conversation-avatar"},be=["src","alt"],Me={key:0,class:"online-indicator"},$e={class:"conversation-info"},Te={class:"conversation-name"},xe={class:"conversation-preview"},Ie={class:"conversation-meta"},Se={class:"conversation-time"},De={key:0,class:"unread-badge"},Ve={class:"conversation-panel"},Ne={key:0,class:"no-conversation"},Fe={class:"conversation-header"},Ee={class:"header-info"},Ae=["src","alt"],Le={class:"participant-details"},Ue={class:"participant-name"},Be={class:"participant-status"},Oe={key:0,class:"typing-indicator"},Pe={key:0,class:"loading-container"},Re={key:1,class:"empty-messages"},Ke={key:2,class:"messages-list"},He=["src","alt"],je={class:"message-bubble"},ze={class:"message-text"},We={key:0,class:"message-attachment"},Ye=["src"],qe={class:"message-time"},Ge={key:0,class:"edited-label"},Je={key:0,class:"typing-bubble"},Qe={class:"message-input-container"},Xe=["onKeydown"],Ze=["disabled"],es={class:"modal-header"},ss={class:"modal-body"},ts={class:"modal-footer"},as=ae({__name:"MessagesView",props:{conversationId:{}},setup(W){const M=W;ce();const A=re(),L=de(),c=u([]),d=u([]),o=u(null),C=u(""),g=u(""),$=u(!0),T=u(!1),x=u(!1),h=u(!1),y=u(""),b=u(null);let w=null,k=null;const U=R(()=>{if(!C.value)return c.value;const a=C.value.toLowerCase();return c.value.filter(s=>{var e;return s.participant_name.toLowerCase().includes(a)||((e=s.last_message)==null?void 0:e.toLowerCase().includes(a))})}),v=R(()=>o.value?c.value.find(a=>a.conversation_id===o.value):null),Y=a=>{const s=new Date(a),r=new Date().getTime()-s.getTime(),n=Math.floor(r/6e4),m=Math.floor(r/36e5),D=Math.floor(r/864e5);return n<1?"now":n<60?`${n}m`:m<24?`${m}h`:D===1?"yesterday":D<7?`${D}d`:s.toLocaleDateString()},q=a=>new Date(a).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),G=async()=>{var a,s,e,r;try{$.value=!0;const n=await _.get("/conversations");(a=n==null?void 0:n.data)!=null&&a.success&&((e=(s=n==null?void 0:n.data)==null?void 0:s.data)!=null&&e.conversations)?c.value=n.data.data.conversations:(r=n==null?void 0:n.data)!=null&&r.conversations?c.value=n.data.conversations:Array.isArray(n==null?void 0:n.data)?c.value=n.data:c.value=[]}catch(n){console.error("Error loading conversations:",n),c.value=[]}finally{$.value=!1}},I=async()=>{if(o.value)try{T.value=!0;const a=await _.get(`/conversations/${o.value}/messages`);a.data.success&&a.data.data.messages&&(d.value=a.data.data.messages.map(s=>{var e;return{...s,is_own:s.sender_id===((e=L.user)==null?void 0:e.user_id)}}),await E(),S(),P())}catch(a){console.error("Error loading messages:",a)}finally{T.value=!1}},B=a=>{o.value=a,A.push(`/messages/${a}`),I()},O=async()=>{if(!g.value.trim()||!o.value)return;const a={message_id:Date.now(),message_text:g.value.trim(),is_own:!0,created_at:new Date().toISOString(),sending:!0};try{d.value.push(a);const s=g.value.trim();g.value="",await E(),S();const e=await _.post(`/conversations/${o.value}/messages`,{message_text:s});if(e.data.success&&e.data.data.message){const r=d.value.findIndex(m=>m.message_id===a.message_id);r!==-1&&(d.value[r]={...e.data.data.message,is_own:!0});const n=c.value.find(m=>m.conversation_id===o.value);n&&(n.last_message=s,n.updated_at=e.data.data.message.created_at)}}catch(s){d.value=d.value.filter(e=>e.message_id!==a.message_id),g.value=a.message_text,toast.error(s.message||"Failed to send message")}},J=()=>{o.value&&(_.post(`/conversations/${o.value}/typing`),w&&clearTimeout(w),w=setTimeout(()=>{},2e3))},P=async()=>{if(o.value)try{await _.patch(`/conversations/${o.value}/read`);const a=c.value.find(s=>s.conversation_id===o.value);a&&(a.unread_count=0)}catch(a){console.error("Error marking as read:",a)}},S=()=>{b.value&&(b.value.scrollTop=b.value.scrollHeight)},Q=async()=>{var a,s;if(y.value.trim())try{const e=await _.post("/conversations",{participant_username:y.value.trim()});if(e.data.success&&e.data.data.conversation){const r=e.data.data.conversation;c.value.unshift(r),B(r.conversation_id),h.value=!1,y.value=""}}catch(e){alert(((s=(a=e.response)==null?void 0:a.data)==null?void 0:s.message)||"Failed to start conversation")}},X=async()=>{var a,s;if(!(!o.value||!confirm("Delete this conversation?")))try{await _.delete(`/conversations/${o.value}`),c.value=c.value.filter(e=>e.conversation_id!==o.value),o.value=null,d.value=[]}catch(e){alert(((s=(a=e.response)==null?void 0:a.data)==null?void 0:s.message)||"Failed to delete conversation")}},Z=()=>{v.value&&A.push(`/profile/${v.value.participant_username}`)},ee=()=>{console.log("File attachment coming soon")},se=()=>{k||(k=setInterval(async()=>{var a;if(o.value){const s=(a=d.value[d.value.length-1])==null?void 0:a.message_id;try{const e=await _.get(`/conversations/${o.value}/messages?after=${s||0}`);if(e.data.success&&e.data.data.messages){const r=e.data.data.messages.map(n=>{var m;return{...n,is_own:n.sender_id===((m=L.user)==null?void 0:m.user_id)}});r.length>0&&(d.value.push(...r),await E(),S(),P())}}catch(e){console.error("Error polling messages:",e)}try{const e=await _.get(`/conversations/${o.value}/typing`);e.data.success&&e.data.data.typing_users&&(x.value=e.data.data.typing_users.length>0)}catch(e){console.error("Error checking typing status:",e)}}},3e3))},te=()=>{k&&(clearInterval(k),k=null)};return ne(()=>M.conversationId,a=>{a&&(o.value=parseInt(a),I())}),oe(()=>{G(),M.conversationId&&(o.value=parseInt(M.conversationId),I()),se()}),ie(()=>{te(),w&&clearTimeout(w)}),(a,s)=>(l(),i("div",ve,[t("div",me,[t("div",pe,[t("div",_e,[t("h2",null,p(a.$t("navigation.messages")),1),t("button",{onClick:s[0]||(s[0]=e=>h.value=!0),class:"btn-new-message"},[...s[8]||(s[8]=[t("span",{class:"icon"},"âœ‰ï¸",-1)])])]),t("div",ge,[V(t("input",{"onUpdate:modelValue":s[1]||(s[1]=e=>C.value=e),type:"text",placeholder:a.$t("common.actions.search")+" conversations...",class:"search-input"},null,8,fe),[[N,C.value]])]),$.value?(l(),i("div",he,[...s[9]||(s[9]=[t("div",{class:"spinner"},null,-1)])])):U.value.length===0?(l(),i("div",ye,[...s[10]||(s[10]=[t("p",null,"No conversations yet",-1)])])):(l(),i("div",we,[(l(!0),i(F,null,K(U.value,e=>(l(),i("div",{key:e.conversation_id,class:z(["conversation-item",{active:o.value===e.conversation_id}]),onClick:r=>B(e.conversation_id)},[t("div",Ce,[t("img",{src:e.participant_avatar||"/assets/images/default-avatar.svg",alt:e.participant_name},null,8,be),e.is_online?(l(),i("span",Me)):f("",!0)]),t("div",$e,[t("div",Te,p(e.participant_name),1),t("div",xe,p(e.last_message||"No messages"),1)]),t("div",Ie,[t("span",Se,p(Y(e.updated_at)),1),e.unread_count>0?(l(),i("span",De,p(e.unread_count),1)):f("",!0)])],10,ke))),128))]))]),t("div",Ve,[v.value?(l(),i(F,{key:1},[t("div",Fe,[t("div",Ee,[t("img",{src:v.value.participant_avatar||"/assets/images/default-avatar.svg",alt:v.value.participant_name,class:"participant-avatar"},null,8,Ae),t("div",Le,[t("div",Ue,p(v.value.participant_name),1),t("div",Be,[H(p(v.value.is_online?"Online":"Offline")+" ",1),x.value?(l(),i("span",Oe," - typing...")):f("",!0)])])]),t("div",{class:"header-actions"},[t("button",{onClick:Z,class:"btn-icon",title:"View Profile"},[...s[12]||(s[12]=[t("span",null,"ðŸ‘¤",-1)])]),t("button",{onClick:X,class:"btn-icon",title:"Delete Conversation"},[...s[13]||(s[13]=[t("span",null,"ðŸ—‘ï¸",-1)])])])]),t("div",{ref_key:"messagesContainer",ref:b,class:"messages-thread"},[T.value?(l(),i("div",Pe,[...s[14]||(s[14]=[t("div",{class:"spinner"},null,-1)])])):d.value.length===0?(l(),i("div",Re,[...s[15]||(s[15]=[t("p",null,"No messages yet. Start the conversation!",-1)])])):(l(),i("div",Ke,[(l(!0),i(F,null,K(d.value,e=>(l(),i("div",{key:e.message_id,class:z(["message-item",{own:e.is_own}])},[e.is_own?f("",!0):(l(),i("img",{key:0,src:v.value.participant_avatar||"/assets/images/default-avatar.svg",alt:v.value.participant_name,class:"message-avatar"},null,8,He)),t("div",je,[t("div",ze,p(e.message_text),1),e.attachment_url?(l(),i("div",We,[t("img",{src:e.attachment_url,alt:"Attachment",class:"attachment-image"},null,8,Ye)])):f("",!0),t("div",qe,[H(p(q(e.created_at))+" ",1),e.edited_at?(l(),i("span",Ge,"(edited)")):f("",!0)])])],2))),128)),x.value?(l(),i("div",Je,[...s[16]||(s[16]=[t("div",{class:"typing-dots"},[t("span"),t("span"),t("span")],-1)])])):f("",!0)]))],512),t("div",Qe,[t("button",{onClick:ee,class:"btn-attach",title:"Attach File"},[...s[17]||(s[17]=[t("span",null,"ðŸ“Ž",-1)])]),V(t("textarea",{"onUpdate:modelValue":s[2]||(s[2]=e=>g.value=e),onKeydown:le(j(O,["exact","prevent"]),["enter"]),onInput:J,placeholder:"Type a message...",class:"message-input",rows:"1"},null,40,Xe),[[N,g.value]]),t("button",{onClick:O,disabled:!g.value.trim(),class:"btn-send"},[...s[18]||(s[18]=[t("span",null,"ðŸ“¤",-1)])],8,Ze)])],64)):(l(),i("div",Ne,[...s[11]||(s[11]=[t("div",{class:"empty-icon"},"ðŸ’¬",-1),t("h3",null,"Select a conversation",-1),t("p",null,"Choose a conversation from the list to start messaging",-1)])]))])]),h.value?(l(),i("div",{key:0,class:"modal-overlay",onClick:s[7]||(s[7]=e=>h.value=!1)},[t("div",{class:"modal-content",onClick:s[6]||(s[6]=j(()=>{},["stop"]))},[t("div",es,[s[19]||(s[19]=t("h3",null,"New Message",-1)),t("button",{onClick:s[3]||(s[3]=e=>h.value=!1),class:"btn-close"},"Ã—")]),t("div",ss,[V(t("input",{"onUpdate:modelValue":s[4]||(s[4]=e=>y.value=e),type:"text",placeholder:"Enter username...",class:"username-input"},null,512),[[N,y.value]])]),t("div",ts,[t("button",{onClick:s[5]||(s[5]=e=>h.value=!1),class:"btn-secondary"},"Cancel"),t("button",{onClick:Q,class:"btn-primary"},"Start")])])])):f("",!0)]))}}),ls=ue(as,[["__scopeId","data-v-e141337f"]]);export{ls as default};
//# sourceMappingURL=MessagesView-B9IzhqpG.js.map
