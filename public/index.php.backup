<?php
/**
 * Wall Social Platform - Application Entry Point
 * 
 * Main router and request handler for the application.
 * Routes all HTTP requests to appropriate controllers.
 */

// Error reporting for development
error_reporting(E_ALL);
ini_set('display_errors', '1');

// Set timezone
date_default_timezone_set('UTC');

// Autoloader (will be replaced by Composer autoloader)
spl_autoload_register(function ($class) {
    $paths = [
        __DIR__ . '/../src/Controllers/',
        __DIR__ . '/../src/Models/',
        __DIR__ . '/../src/Services/',
        __DIR__ . '/../src/Utils/',
        __DIR__ . '/../config/',
    ];
    
    foreach ($paths as $path) {
        $file = $path . $class . '.php';
        if (file_exists($file)) {
            require_once $file;
            return;
        }
    }
});

// CORS headers for API
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');

// Handle preflight requests
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit;
}

// Get request URI and method
$requestUri = $_SERVER['REQUEST_URI'];
$requestMethod = $_SERVER['REQUEST_METHOD'];

// Remove query string from URI
$requestUri = strtok($requestUri, '?');

// Parse route
$route = trim($requestUri, '/');
$routeParts = explode('/', $route);

/**
 * Simple router implementation
 * 
 * Routes format: METHOD /path/to/resource
 */
function route(string $method, string $pattern, callable $handler): bool {
    global $requestMethod, $route;
    
    if ($requestMethod !== $method) {
        return false;
    }
    
    // Convert pattern to regex
    $pattern = preg_replace('/\{([a-zA-Z0-9_]+)\}/', '(?P<$1>[^/]+)', $pattern);
    $pattern = '#^' . $pattern . '$#';
    
    if (preg_match($pattern, $route, $matches)) {
        // Extract named parameters
        $params = array_filter($matches, 'is_string', ARRAY_FILTER_USE_KEY);
        
        // Call handler with parameters
        call_user_func($handler, $params);
        return true;
    }
    
    return false;
}

/**
 * Send JSON response
 */
function jsonResponse(bool $success, $data = null, ?string $message = null, int $statusCode = 200): void {
    http_response_code($statusCode);
    header('Content-Type: application/json');
    
    $response = ['success' => $success];
    
    if ($data !== null) {
        $response['data'] = $data;
    }
    
    if ($message !== null) {
        $response['message'] = $message;
    }
    
    if (!$success && $data !== null) {
        $response['error'] = $data;
        unset($response['data']);
    }
    
    echo json_encode($response, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES);
    exit;
}

/**
 * Get JSON request body
 */
function getJsonInput(): ?array {
    $input = file_get_contents('php://input');
    return json_decode($input, true);
}

// ==============================================
// Routes Definition
// ==============================================

// Home page
route('GET', '', function() {
    ?>
    <!DOCTYPE html>
    <html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Wall Social Platform</title>
        <style>
            * { margin: 0; padding: 0; box-sizing: border-box; }
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                color: #fff;
            }
            .container {
                text-align: center;
                padding: 2rem;
                max-width: 800px;
            }
            h1 {
                font-size: 3rem;
                margin-bottom: 1rem;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            }
            p {
                font-size: 1.25rem;
                margin-bottom: 2rem;
                opacity: 0.9;
            }
            .features {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 1.5rem;
                margin-top: 3rem;
            }
            .feature {
                background: rgba(255, 255, 255, 0.1);
                padding: 1.5rem;
                border-radius: 12px;
                backdrop-filter: blur(10px);
            }
            .feature h3 {
                margin-bottom: 0.5rem;
                font-size: 1.25rem;
            }
            .status {
                margin-top: 3rem;
                padding: 1rem;
                background: rgba(255, 255, 255, 0.2);
                border-radius: 8px;
            }
            .status-ok { color: #4ade80; }
            .status-error { color: #f87171; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>ðŸ§± Wall Social Platform</h1>
            <p>AI-Powered Social Network with AI-Generated Web Applications</p>
            
            <div class="features">
                <div class="feature">
                    <h3>ðŸ¤– AI Generation</h3>
                    <p>Create web apps using AI prompts powered by Ollama</p>
                </div>
                <div class="feature">
                    <h3>ðŸ”„ Remix & Fork</h3>
                    <p>Collaborate and iterate on existing applications</p>
                </div>
                <div class="feature">
                    <h3>ðŸ§± Bricks Currency</h3>
                    <p>Token-based system for managing AI resources</p>
                </div>
                <div class="feature">
                    <h3>ðŸ’¬ Social Features</h3>
                    <p>Comments, reactions, messaging, and friendships</p>
                </div>
            </div>
            
            <div class="status">
                <strong>Status:</strong> 
                <span class="status-ok">âœ“ Application Running</span><br>
                <small>Phase 1: Environment Setup Complete</small>
            </div>
        </div>
    </body>
    </html>
    <?php
    exit;
});

// API Health Check
route('GET', 'health', function() {
    try {
        // Check database connection
        $db = Database::getConnection();
        $dbStatus = 'connected';
    } catch (Exception $e) {
        $dbStatus = 'error: ' . $e->getMessage();
    }
    
    try {
        // Check Redis connection
        $redis = RedisConnection::getConnection();
        $redisStatus = 'connected';
    } catch (Exception $e) {
        $redisStatus = 'error: ' . $e->getMessage();
    }
    
    jsonResponse(true, [
        'status' => 'healthy',
        'timestamp' => date('Y-m-d H:i:s'),
        'services' => [
            'database' => $dbStatus,
            'redis' => $redisStatus,
        ]
    ]);
});

// API Info
route('GET', 'api/v1', function() {
    jsonResponse(true, [
        'name' => 'Wall Social Platform API',
        'version' => '1.0',
        'status' => 'active',
        'endpoints' => [
            'auth' => '/api/v1/auth/*',
            'walls' => '/api/v1/walls/*',
            'posts' => '/api/v1/posts/*',
            'ai' => '/api/v1/ai/*',
            'users' => '/api/v1/users/*',
            'messaging' => '/api/v1/conversations/*',
            'bricks' => '/api/v1/bricks/*',
        ]
    ]);
});

// Authentication Routes (Placeholder)
route('POST', 'api/v1/auth/register', function() {
    jsonResponse(false, ['code' => 'NOT_IMPLEMENTED'], 'Registration endpoint not yet implemented', 501);
});

route('POST', 'api/v1/auth/login', function() {
    jsonResponse(false, ['code' => 'NOT_IMPLEMENTED'], 'Login endpoint not yet implemented', 501);
});

route('POST', 'api/v1/auth/logout', function() {
    jsonResponse(false, ['code' => 'NOT_IMPLEMENTED'], 'Logout endpoint not yet implemented', 501);
});

// AI Generation Routes (Placeholder)
route('POST', 'api/v1/ai/generate', function() {
    jsonResponse(false, ['code' => 'NOT_IMPLEMENTED'], 'AI generation endpoint not yet implemented', 501);
});

route('GET', 'api/v1/ai/jobs/{jobId}', function($params) {
    jsonResponse(false, ['code' => 'NOT_IMPLEMENTED'], 'Job status endpoint not yet implemented', 501);
});

// Queue Monitor Route (Placeholder)
route('GET', 'api/v1/queue/status', function() {
    jsonResponse(false, ['code' => 'NOT_IMPLEMENTED'], 'Queue status endpoint not yet implemented', 501);
});

// 404 Not Found
http_response_code(404);
jsonResponse(false, [
    'code' => 'NOT_FOUND',
    'message' => 'Endpoint not found',
    'path' => $requestUri,
    'method' => $requestMethod
], null, 404);

